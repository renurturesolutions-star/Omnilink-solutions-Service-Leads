<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OmniSolutions ‚Äî All-in-One Service Network</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
<style>
:root{
  --bg1:#0b0a18; --bg2:#141229; --ink:#f6f7fb; --muted:#c6c9de;
  --brand:#8a5cff; --brand2:#6a4cff; --chip:#262248; --chip2:#1e1a3b;
  --good:#22d3a6; --bad:#ff5c7a;
  --shadow:0 14px 32px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Poppins,system-ui; color:var(--ink);
  background:radial-gradient(1200px 800px at 10% -10%, #1a1740, #0b0a18 50%, #090818 100%);
  overflow-x:hidden;
}
h1{margin:0;font-size:clamp(22px,3.5vw,40px);letter-spacing:.2px}
a{color:inherit}
.badge{
  width:62px;height:62px;border-radius:16px;display:grid;place-items:center;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  font-weight:900;color:#0a061b;box-shadow:0 10px 26px #8a5cff55;margin:auto;
}
.sub{color:var(--muted);margin-top:6px;font-size:15px}
.hero{width:min(1200px,94vw);margin:30px auto 10px;position:relative;text-align:center}
.cta-bar{width:min(1200px,94vw);margin:10px auto 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.btn{
  background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0b0622;
  border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)
}
.btn.secondary{background:#231f41;color:#fff}
.btn.danger{background:#ff5c7a;color:white}
.btn:hover{opacity:.92}
.top-right{position:absolute;top:10px;right:12px;display:flex;gap:8px}
.chip{background:var(--chip);border:1px solid #ffffff14;padding:8px 10px;border-radius:999px;color:#e8e9ff}

.section{width:min(1200px,94vw);margin:28px auto}
.section h2{margin:14px 0 10px;font-size:22px}
.group{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  border:1px solid #ffffff18;border-radius:16px;padding:14px 14px;box-shadow:var(--shadow);margin-bottom:14px}
.group-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.group-title{font-weight:800}
.group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px;transition:max-height .35s ease}
.bubble{background:#231f41;color:#fff;padding:12px;border-radius:999px;text-align:center;font-weight:700;cursor:pointer;border:1px solid #ffffff14}
.bubble:hover{background:linear-gradient(135deg,var(--brand),var(--brand2));transform:translateY(-2px)}
.hidden{display:none}

.testimonials{margin-top:28px;text-align:center}
.t-card{display:inline-block;background:#231f41;border:1px solid #ffffff14;padding:18px;border-radius:16px;max-width:720px;box-shadow:var(--shadow)}
.stars{color:#ffd166;margin:6px 0}

.live{margin-top:12px;text-align:center;color:#bfc3e0}

.chat-popup{
  position:fixed;bottom:96px;right:20px;width:340px;max-height:520px;
  background:#18152f;border:1px solid #ffffff1a;border-radius:14px;
  display:none;flex-direction:column;z-index:50;box-shadow:var(--shadow)
}
.chat-head{padding:10px 12px;border-bottom:1px solid #ffffff18;font-weight:800}
.chat-log{padding:10px 12px;flex:1;overflow:auto}
.msg{max-width:80%;padding:9px 11px;border-radius:12px;margin:6px 0;background:var(--chip2)}
.msg.bot{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0e0727}
.msg.user{align-self:flex-end;background:#2e2b48}
.chat-compose{display:flex;gap:8px;padding:10px;border-top:1px solid #ffffff18}
input,textarea{width:100%;padding:10px;border:none;border-radius:10px;background:#211d3b;color:#fff}
canvas#confetti{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:100}

.modal-backdrop{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:60}
.modal{width:min(900px,94vw);background:#151230;border:1px solid #ffffff20;border-radius:18px;padding:16px;max-height:84vh;overflow:auto}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.row{grid-template-columns:1fr}}
.ok{display:none;color:var(--good);font-weight:800;margin-top:8px}

.table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
.table th{font-size:12px;text-align:left;color:#cdd3f6}
.table td{background:#201c3c;border:1px solid #ffffff15;padding:8px;border-radius:8px}
.tools{display:flex;gap:8px;margin:6px 0 2px}

.footer{color:#aab0cf;text-align:center;margin:36px 0 60px}
.small{font-size:12px;color:#cbd0ef}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<section class="hero">
  <div class="top-right">
    <button class="btn secondary" id="openAdmin">üîí Admin</button>
    <a class="btn secondary" href="contractor.html">üìä Contractor Dashboard</a>
    <button class="btn secondary" id="openContractor">üß∞ Join as Contractor</button>
    <button class="btn" id="openReview">‚≠ê Leave a Review</button>
  </div>
  <div class="badge">OS</div>
  <h1>OmniSolutions ‚Äî All-in-One Service Network</h1>
  <p class="sub">From repairs to renovations, from sales to support ‚Äî every solution under one roof.</p>
  <div class="cta-bar">
    <span class="chip">Cheapest. Fastest. Vetted partners.</span>
    <span class="chip">Avg response 1‚Äì2 hrs</span>
    <span class="chip">24/7 emergencies</span>
  </div>
</section>

<section class="section" id="catalog">
  <h2>Choose a category, then tap a service:</h2>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üè† Property & Maintenance</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üßπ Cleaning & Hygiene</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üîß Renovations & Construction</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üè° Property Sales & Rentals</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üíº Business & Professional</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üîí Security, Energy & Tech</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üöó Automotive & Machinery</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üßë‚Äçü§ù‚Äçüßë Personal & Lifestyle</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>

  <div class="group">
    <div class="group-header" data-toggle>
      <div class="group-title">üåç Environmental & Utilities</div><div>‚ñº</div>
    </div>
    <div class="group-grid"></div>
  </div>
</section>

<section class="section testimonials">
  <div class="t-card">
    <div>‚ÄúBooked a plumber and had someone at my door in 45 minutes. Pricing was fair and super clean work.‚Äù</div>
    <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
    <div style="color:#cfd6ff">‚Äî Nomsa M., Durban</div>
  </div>
</section>

<section class="section live">
  <div id="liveFeed">üí¨ Sipho in Pretoria just booked Roofing ‚Ä¢ Sarah in Randburg booked Cleaning ‚Ä¢ Yusuf in Cape Town booked CCTV</div>
</section>

<!-- Contractor modal -->
<div class="modal-backdrop" id="cBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üö® New Partner Sign-Up</h3>
      <button class="btn" id="cClose" style="padding:6px 10px;font-size:12px">Close</button>
    </div>
    <p class="small">Join the OmniSolutions network ‚Äî we route paying jobs to you.</p>
    <div class="row" style="margin-top:6px">
      <input id="bizName" placeholder="Business / Contractor Name">
      <input id="ownerName" placeholder="Contact Person">
    </div>
    <div class="row">
      <input id="bizEmail" placeholder="Email">
      <input id="bizPhone" placeholder="Phone">
    </div>
    <div class="row">
      <select id="bizCategory"></select>
      <input id="areas" placeholder="Service Areas (e.g., Durban, JHB, Cape Town)">
    </div>
    <div class="row">
      <input id="specialty" placeholder="Specialty (e.g., Geysers, Rewiring, Deep Cleaning)">
      <input id="website" placeholder="Website / Portfolio (optional)">
    </div>
    <button class="btn" id="conSubmit" style="margin-top:8px">Submit</button>
    <div class="ok" id="conOk">‚úÖ Submitted! You‚Äôll appear in local matches immediately.</div>
    <p class="small" style="margin-top:8px">Contractors: access your dashboard via the top-right ‚ÄúContractor Dashboard‚Äù.</p>
  </div>
</div>

<!-- Admin modal -->
<div class="modal-backdrop" id="aBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üîß Admin ‚Äî Partners, Leads & Messages</h3>
      <button class="btn" id="aClose" style="padding:6px 10px;font-size:12px">Close</button>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
      <button class="btn" id="exportPartners">Export Partners CSV</button>
      <button class="btn" id="exportLeads">Export Leads CSV</button>
      <button class="btn danger" id="clearPartners">Clear Partners</button>
      <button class="btn danger" id="clearLeads">Clear Leads</button>
      <button class="btn" id="changeAdminPin">Change Admin PIN</button>
    </div>

    <h4 style="margin:14px 0 6px">Partners</h4>
    <div style="overflow:auto;max-height:24vh">
      <table class="table" id="partnersTable">
        <thead>
          <tr><th>Business</th><th>Contact</th><th>Phone</th><th>Category</th><th>Service</th><th>Areas</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h4 style="margin:18px 0 6px">Leads / Jobs</h4>
    <div style="overflow:auto;max-height:24vh">
      <table class="table" id="leadsTable">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Phone</th><th>Area</th><th>Category</th><th>Service</th><th>Notes</th><th>Assigned To</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h4 style="margin:18px 0 6px">Direct Messages</h4>
    <div class="row">
      <select id="dmSelect"></select>
      <input id="dmText" placeholder="Type a message to selected contractor">
    </div>
    <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="sendDM">Send DM</button>
      <button class="btn" id="broadcastAll">Broadcast to All (unmuted)</button>
    </div>
    <div id="dmOk" class="ok">‚úÖ Sent.</div>
  </div>
</div>

<!-- Review modal -->
<div class="modal-backdrop" id="rBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>‚≠ê Leave a Review</h3>
      <button class="btn" id="rClose" style="padding:6px 10px;font-size:12px">Close</button>
    </div>
    <p class="small">Enter the Job ID we sent you (or shown at the end of chat).</p>
    <div class="row">
      <input id="revJobId" placeholder="Job ID (e.g., J-1731200430000)">
      <input id="revStars" placeholder="Stars 1‚Äì5 (e.g., 5)">
    </div>
    <div class="row">
      <input id="revName" placeholder="Your name">
      <input id="revPhone" placeholder="Your phone">
    </div>
    <textarea id="revComment" placeholder="Tell us about the service"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" id="revSubmit">Submit Review</button>
      <div id="revOk" class="ok">‚úÖ Thanks for your review!</div>
    </div>
  </div>
</div>

<!-- Chat -->
<div class="chat-popup" id="chat">
  <div class="chat-head">üíú OmniSolutions Assistant</div>
  <div class="chat-log" id="chatLog"></div>
  <div class="chat-compose">
    <input id="chatInput" placeholder="Type your answer‚Ä¶ then Enter" autocomplete="off" />
  </div>
</div>

<div class="footer">¬© 2025 OmniSolutions ‚Äî All rights reserved</div>

<script>
/* ================== Settings (Telegram) ================== */
const TELEGRAM_BOT_TOKEN = "8590267654:AAG24Oo6GlAUjVxZ1JXjNLNq_LZ5gIK4BDs";
const TELEGRAM_CHAT_IDS = ["8187670531","8558139331"]; // you + client
async function sendTelegram(text, specificId=null){
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const ids = specificId ? [specificId] : TELEGRAM_CHAT_IDS;
  for(const chat_id of ids){
    try{
      await fetch(url,{method:"POST",headers:{'Content-Type':'application/json'},
        body:JSON.stringify({chat_id, text, parse_mode:"Markdown"})});
    }catch(e){}
  }
}

/* ================== Admin PIN (not hard-coded) ==================
   First use: prompt to set PIN -> stored in localStorage ("omni_admin_pin").
   Access: prompt and compare. You can change it inside Admin modal. */
function getAdminPin(){ return localStorage.getItem('omni_admin_pin') || null; }
function setAdminPin(v){ localStorage.setItem('omni_admin_pin', v); }

/* ================== Data helpers ================== */
function load(k, f){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(f)); } catch{ return f; } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function loadPartners(){ return load('omni_partners', []); }
function savePartners(v){ save('omni_partners', v); }

function loadLeads(){ return load('omni_leads', []); } // legacy list of raw leads
function saveLeads(v){ save('omni_leads', v); }

function jobs(){ return load('omni_jobs', []); }
function saveJobs(v){ save('omni_jobs', v); }

function reviews(){ return load('omni_reviews', []); }
function saveReviews(v){ save('omni_reviews', v); }

function msgsFor(phone){ return load('omni_msgs_'+phone, []); }
function saveMsgsFor(phone, arr){ save('omni_msgs_'+phone, arr); }

/* ================== Categories & Services ================== */
const CATEGORY_MAP = {
  "Property & Maintenance":[
    "Plumbing","Electrical","Roofing","Carpentry","Painting","Handyman","HVAC","Flooring",
    "Masonry","Gutter Cleaning","Pest Control","Landscaping","Pool Maintenance","Appliance Repair",
    "Waterproofing","Irrigation","Window Repair","Glass/Glazing","Ceilings & Drywall","Tiling"
  ],
  "Cleaning & Hygiene":[
    "Home Cleaning","Office Cleaning","Deep Cleaning","Move-in/Move-out","Carpet Cleaning","Window Cleaning",
    "Janitorial Services","Sanitizing","Laundry Collection","Upholstery Cleaning","Post-Construction Cleaning"
  ],
  "Renovations & Construction":[
    "General Building","Kitchen Renovations","Bathroom Renovations","Home Extensions","Concrete Work",
    "Steelwork & Welding","Joinery","Scaffolding","Paving","Drywall & Ceilings","Waterproofing","Project Management"
  ],
  "Property Sales & Rentals":[
    "Real Estate Agent","Property Management","Valuations","Apartment Rentals","Commercial Sales",
    "Short-Term Letting","Estate Photography","Home Staging","Bond Origination"
  ],
  "Business & Professional":[
    "Accounting","Legal Advice","Bookkeeping","IT Support","Web Design","Digital Marketing","Branding/Printing",
    "Admin Assistance","Courier Services","Recruitment","Company Registrations"
  ],
  "Security, Energy & Tech":[
    "CCTV Installation","Alarm Systems","Access Control","Electric Fencing","Gate Motors","Networking & Wi-Fi",
    "Smart Home Setup","Solar Installation","Inverters & Batteries","Generator Install/Maintenance"
  ],
  "Automotive & Machinery":[
    "Vehicle Service/Repair","Tyre Fitment","Panel Beating","Auto Electrician","Towing",
    "Truck Maintenance","Diesel Mechanics","Air Compressors","Forklifts/Plant"
  ],
  "Personal & Lifestyle":[
    "Personal Trainer","Tutors","Event Planning","Catering","Beauty Services","Barber/Hair",
    "Pet Grooming","Childcare","Elder Care","Photography/Videography","DJ/Entertainment"
  ],
  "Environmental & Utilities":[
    "Boreholes/Water","Water Treatment","Waste Disposal","Recycling","Tree Felling",
    "Energy Audits","Garden Services","Fire Safety/Extinguishers","Environmental Compliance"
  ]
};

/* Build the catalog UI */
const groups = document.querySelectorAll('.group');
const catNames = Object.keys(CATEGORY_MAP);
groups.forEach((grp,i)=>{
  const grid = grp.querySelector('.group-grid');
  const header = grp.querySelector('[data-toggle]');
  const cname = catNames[i];
  CATEGORY_MAP[cname].forEach(svc=>{
    const b = document.createElement('div');
    b.className='bubble';
    b.textContent = svc;
    b.onclick = ()=>startChat(cname, svc);
    grid.appendChild(b);
  });
  header.onclick = ()=>{ grid.classList.toggle('hidden'); };
});

/* ================== Contractor signup ================== */
const cBackdrop = document.getElementById('cBackdrop');
document.getElementById('openContractor').onclick = ()=> {
  cBackdrop.style.display='grid';
  populateCategorySelect();
};
document.getElementById('cClose').onclick = ()=> cBackdrop.style.display='none';

function populateCategorySelect(){
  const sel = document.getElementById('bizCategory');
  sel.innerHTML = '';
  for(const [cat, services] of Object.entries(CATEGORY_MAP)){
    const og = document.createElement('optgroup'); og.label = cat;
    services.forEach(s=>{
      const opt = document.createElement('option'); opt.value = `${cat}::${s}`; opt.textContent = s;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  }
}

document.getElementById('conSubmit').onclick = async ()=>{
  const name = document.getElementById('bizName').value.trim();
  const contact = document.getElementById('ownerName').value.trim();
  const email = document.getElementById('bizEmail').value.trim();
  const phone = document.getElementById('bizPhone').value.trim();
  const svcSel = document.getElementById('bizCategory').value; // "Category::Service"
  const areas = document.getElementById('areas').value.trim();
  const specialty = document.getElementById('specialty').value.trim();
  const website = document.getElementById('website').value.trim();

  if(!name || !phone || !svcSel){ alert('Please fill name, phone and service.'); return; }
  const [category, service] = svcSel.split('::');

  const partners = loadPartners();
  partners.push({
    id: 'p_'+Date.now(),
    business: name, contact, email, phone,
    category, service, areas, specialty, website,
    created: new Date().toISOString(),
    muted: false // admin can mute to stop dispatch
  });
  savePartners(partners);

  const msg = `üö® *New Partner Alert*\nüè¢ ${name}\nüë§ ${contact}\nüìû ${phone}\nüìß ${email}\nüß∞ ${category} ‚Üí ${service}\nüìç Areas: ${areas}\n‚≠ê Specialty: ${specialty}\nüîó ${website||'-'}\nüïí ${new Date().toLocaleString()}`;
  await sendTelegram(msg);

  document.getElementById('conOk').style.display='block';
  confettiBurst();
  setTimeout(()=>{ cBackdrop.style.display='none'; document.getElementById('conOk').style.display='none'; }, 2200);
};

/* ================== Seed sample partners (for demo) ================== */
(function seed(){
  const partners = loadPartners();
  if(partners.length) return;
  const samples = [
    {business:"RapidFlow Plumbing",contact:"Thabo",phone:"0821112222",category:"Property & Maintenance",service:"Plumbing",areas:"Cape Town; Milnerton; Table View",specialty:"Geysers",muted:false},
    {business:"SparkRight Electrical",contact:"Nomsa",phone:"0832223333",category:"Property & Maintenance",service:"Electrical",areas:"JHB; Randburg; Sandton",specialty:"Rewiring",muted:false},
    {business:"SkyRoof",contact:"Pieter",phone:"0843334444",category:"Property & Maintenance",service:"Roofing",areas:"Pretoria; Centurion",specialty:"Leaks",muted:false},
    {business:"CrystalClean Pros",contact:"Aisha",phone:"0815556666",category:"Cleaning & Hygiene",service:"Deep Cleaning",areas:"Durban; Umhlanga",specialty:"Post-renovation",muted:false},
    {business:"GuardSight CCTV",contact:"Zed",phone:"0827778888",category:"Security, Energy & Tech",service:"CCTV Installation",areas:"Cape Town; Bellville",specialty:"Retail",muted:false},
    {business:"GreenLeaf Landscapes",contact:"Kea",phone:"0721114444",category:"Property & Maintenance",service:"Landscaping",areas:"JHB; Fourways",specialty:"Irrigation",muted:false},
    {business:"SunGrid Solar",contact:"Mandla",phone:"0715551234",category:"Security, Energy & Tech",service:"Solar Installation",areas:"Pretoria; Midrand",specialty:"Hybrid Systems",muted:false},
    {business:"AutoFix Panel",contact:"Riaz",phone:"0793219876",category:"Automotive & Machinery",service:"Panel Beating",areas:"Cape Town; Epping",specialty:"Insurance",muted:false},
    {business:"TopTile Projects",contact:"Rene",phone:"0605557777",category:"Renovations & Construction",service:"Tiling",areas:"JHB; Roodepoort",specialty:"Porcelain",muted:false},
    {business:"FreshAir HVAC",contact:"Chris",phone:"0659081122",category:"Property & Maintenance",service:"HVAC",areas:"Durban; Pinetown",specialty:"Commercial",muted:false}
  ];
  savePartners(samples);
})();

/* ================== Live feed ticker (simple) ================== */
(function ticker(){
  const el = document.getElementById('liveFeed');
  const msgs = [
    "üí¨ Sipho in Pretoria just booked Roofing",
    "üí¨ Sarah in Randburg booked Cleaning",
    "üí¨ Yusuf in Cape Town booked CCTV",
    "üí¨ Thandi in Durban booked Plumbing",
    "üí¨ Jason in Sandton booked Solar install"
  ];
  let i = 0;
  setInterval(()=>{ el.textContent = msgs[i++%msgs.length]; }, 4500);
})();

/* ================== Confetti ================== */
const confettiCanvas = document.getElementById('confetti'), cfx = confettiCanvas.getContext('2d');
function size(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; }
size(); addEventListener('resize', size);
function confettiBurst(){
  const cols = ['#8a5cff','#6a4cff','#23d5ab','#7ee6d5','#ffd166'];
  const parts = Array.from({length:140},()=>({
    x: innerWidth/2, y: innerHeight, r: 3+Math.random()*5,
    dx: -7+Math.random()*14, dy: -12-Math.random()*9,
    c: cols[(Math.random()*cols.length)|0], life: 120
  }));
  let f=0; (function draw(){
    cfx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    parts.forEach(p=>{ cfx.beginPath(); cfx.arc(p.x,p.y,p.r,0,Math.PI*2); cfx.fillStyle=p.c; cfx.fill();
      p.x+=p.dx; p.y+=p.dy; p.dy+=.25; p.life--; });
    f++; if(f<120) requestAnimationFrame(draw); else cfx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  })();
}

/* ================== Chatbot with contractor choose/skip & job creation ================== */
const chat = document.getElementById('chat');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');

let CURRENT = {category:null, service:null, name:null, phone:null, area:null, notes:null, step:0, options:[], chosen:null};

function say(txt, who='bot'){
  const d = document.createElement('div');
  d.className = 'msg '+(who==='bot'?'bot':'user');
  d.textContent = txt;
  chatLog.appendChild(d);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function startChat(category, service){
  CURRENT = {category, service, step:0, options:[], chosen:null};
  chat.style.display='flex';
  chatLog.innerHTML='';
  say(`Hi üëã I'm your OmniSolutions assistant. Let's sort your *${service}* request.`);
  setTimeout(()=>say("What‚Äôs your full name?"), 600);
}

chatInput.addEventListener('keydown', async (e)=>{
  if(e.key!=='Enter') return;
  const val = chatInput.value.trim(); if(!val) return;
  say(val,'user'); chatInput.value='';

  switch(CURRENT.step){
    case 0:
      CURRENT.name = val;
      say(`Nice to meet you, ${CURRENT.name}! üìû Your phone number?`);
      CURRENT.step = 1; break;
    case 1:
      CURRENT.phone = val.replace(/\D/g,'');
      say("üìç Which area/suburb are you in?");
      CURRENT.step = 2; break;
    case 2:
      CURRENT.area = val;
      say("üìù Briefly describe the issue or what you need.");
      CURRENT.step = 3; break;
    case 3:
      CURRENT.notes = val;

      // find partners for selection (respect admin mute)
      const partners = loadPartners().filter(p =>
        !p.muted &&
        p.category===CURRENT.category &&
        p.service===CURRENT.service &&
        (p.areas || '').toLowerCase().includes((CURRENT.area||'').toLowerCase())
      ).slice(0,10);

      if(partners.length){
        CURRENT.options = partners;
        say(`üîé I found ${partners.length} local ${CURRENT.service} provider(s) in ${CURRENT.area}.`);
        partners.forEach((p,i)=> say(`${i+1}. ${p.business} ‚Äî ${p.contact} ‚Äî ${p.phone}`));
        say("Reply with the number of your preferred contractor, or type *skip* for a personal agent.");
        CURRENT.step = 4;
      } else {
        say(`üòÖ No saved partners in ${CURRENT.area} yet for ${CURRENT.service}. We'll route this to a personal agent.`);
        CURRENT.chosen = null; // agent route
        CURRENT.step = 5;
        nextFinalize();
      }
      break;
    case 4: { // choose contractor or skip
      const s = val.toLowerCase();
      if(s==='skip'){ CURRENT.chosen = null; CURRENT.step = 5; nextFinalize(); break; }
      const idx = parseInt(val,10);
      if(!idx || idx<1 || idx>CURRENT.options.length){
        say("Please enter a valid number from the list, or type *skip*.");
      } else {
        CURRENT.chosen = CURRENT.options[idx-1];
        say(`‚úÖ Selected: ${CURRENT.chosen.business}. Finalizing your request‚Ä¶`);
        CURRENT.step = 5; nextFinalize();
      }
      break;
    }
    default: break;
  }
});

async function nextFinalize(){
  // Create a Job ID and store job (optionally assigned)
  const id = "J-"+Date.now();
  const job = {
    id,
    created: new Date().toISOString(),
    customerName: CURRENT.name,
    customerPhone: CURRENT.phone,
    area: CURRENT.area,
    category: CURRENT.category,
    service: CURRENT.service,
    notes: CURRENT.notes,
    status: "Pending",
    contractorPhone: CURRENT.chosen ? CURRENT.chosen.phone : null
  };
  const js = jobs(); js.push(job); saveJobs(js);

  // Legacy leads list (kept for your exports)
  const leads = loadLeads();
  leads.push({
    id, name:CURRENT.name, phone:CURRENT.phone, area:CURRENT.area,
    category:CURRENT.category, service:CURRENT.service, notes:CURRENT.notes,
    time:new Date().toLocaleString(), contractorPhone: job.contractorPhone
  }); saveLeads(leads);

  // Telegram routing
  const base = `üß∞ *NEW JOB*\nID: ${id}\nCategory: ${CURRENT.category}\nService: ${CURRENT.service}\nüë§ ${CURRENT.name}\nüìû ${CURRENT.phone}\nüìç ${CURRENT.area}\nüìù ${CURRENT.notes}\nüïí ${new Date().toLocaleString()}`;
  await sendTelegram( CURRENT.chosen ? (base + `\n\n‚û°Ô∏è Assigned to: ${CURRENT.chosen.business} (${CURRENT.chosen.phone})`) : (base + `\n\n‚û°Ô∏è Assigned to: Personal Agent`) );

  // Optional DM to contractor via Telegram (only if they provided a chat id later in their dashboard, admin can still copy)
  if(CURRENT.chosen && CURRENT.chosen.telegramId){
    await sendTelegram(`üß∞ *New job assigned*\n${id} ‚Ä¢ ${CURRENT.service} ‚Ä¢ ${CURRENT.area}`, CURRENT.chosen.telegramId);
  }

  say(`‚úÖ Thanks! Your request is logged.\nYour Job ID is *${id}*.\nYou can leave a review later via ‚Äú‚≠ê Leave a Review‚Äù.`);
  confettiBurst();
  setTimeout(()=>{ chat.style.display='none'; }, 4000);
}

/* ================== Admin Panel (with DM & Mute) ================== */
const aBackdrop = document.getElementById('aBackdrop');
const openAdminBtn = document.getElementById('openAdmin');
const aClose = document.getElementById('aClose');
const partnersTable = document.querySelector('#partnersTable tbody');
const leadsTable = document.querySelector('#leadsTable tbody');
const dmSelect = document.getElementById('dmSelect');

openAdminBtn.onclick = ()=>{
  let pin = getAdminPin();
  if(!pin){
    const set = prompt("Set a new Admin PIN (numbers only):");
    if(!set){ alert("PIN required."); return; }
    setAdminPin(set);
    alert("Admin PIN set.");
    pin = set;
  }
  const enter = prompt("Enter Admin PIN:");
  if(enter !== pin){ alert("Wrong PIN"); return; }
  aBackdrop.style.display='grid';
  renderPartners();
  renderLeads();
  populateDMSelect();
};
aClose.onclick = ()=> aBackdrop.style.display='none';

document.getElementById('changeAdminPin').onclick = ()=>{
  const cur = prompt("Enter current PIN:");
  if(cur !== getAdminPin()) { alert("Wrong PIN"); return; }
  const np = prompt("Enter new PIN:");
  if(!np){ alert("PIN not changed."); return; }
  setAdminPin(np); alert("PIN updated.");
};

function renderPartners(){
  partnersTable.innerHTML = '';
  loadPartners().forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.business}</td>
      <td>${p.contact||''}</td>
      <td>${p.phone||''}</td>
      <td>${p.category}</td>
      <td>${p.service}</td>
      <td>${p.areas||''}</td>
      <td>${p.muted?'üîá Muted':'üîî Active'}</td>
      <td class="tools">
        <button class="btn" data-id="${p.id}" data-type="mute">${p.muted?'Unmute':'Mute'}</button>
        <button class="btn danger" data-id="${p.id}" data-type="delP">Delete</button>
      </td>
    `;
    partnersTable.appendChild(tr);
  });
}
function renderLeads(){
  leadsTable.innerHTML = '';
  const js = jobs();
  js.forEach(l=>{
    const assigned = l.contractorPhone ? (loadPartners().find(p=>p.phone===l.contractorPhone)?.business||l.contractorPhone) : 'Personal Agent';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.id}</td>
      <td>${l.customerName}</td>
      <td>${l.customerPhone}</td>
      <td>${l.area}</td>
      <td>${l.category}</td>
      <td>${l.service}</td>
      <td>${l.notes||''}</td>
      <td>${assigned}</td>
      <td>${new Date(l.created).toLocaleString()}</td>
      <td class="tools">
        <button class="btn" data-id="${l.id}" data-type="dm">DM Assigned</button>
        <button class="btn danger" data-id="${l.id}" data-type="delL">Delete</button>
      </td>
    `;
    leadsTable.appendChild(tr);
  });
}
function populateDMSelect(){
  dmSelect.innerHTML = '';
  loadPartners().forEach(p=>{
    const o = document.createElement('option');
    o.value = p.phone; o.textContent = `${p.business} (${p.phone}) ${p.muted?'[Muted]':''}`;
    dmSelect.appendChild(o);
  });
}

document.addEventListener('click', e=>{
  const t = e.target;
  if(t.matches('[data-type="delP"]')){
    const id = t.getAttribute('data-id');
    const list = loadPartners().filter(p=>p.id!==id);
    savePartners(list); renderPartners(); populateDMSelect();
  }
  if(t.matches('[data-type="delL"]')){
    const id = t.getAttribute('data-id');
    const j = jobs().filter(x=>x.id!==id); saveJobs(j); renderLeads();
    const l = loadLeads().filter(x=>x.id!==id); saveLeads(l);
  }
  if(t.matches('[data-type="mute"]')){
    const id = t.getAttribute('data-id');
    const list = loadPartners();
    const p = list.find(x=>x.id===id); if(p){ p.muted = !p.muted; savePartners(list); renderPartners(); populateDMSelect(); }
  }
  if(t.matches('[data-type="dm"]')){
    const id = t.getAttribute('data-id');
    const j = jobs().find(x=>x.id===id);
    if(!j) return;
    const msg = prompt("Message to assigned contractor:");
    if(!msg) return;
    if(j.contractorPhone){
      appendDM(j.contractorPhone, {from:'admin', text:msg, when:new Date().toISOString()});
      document.getElementById('dmOk').style.display='block';
      setTimeout(()=>document.getElementById('dmOk').style.display='none',1500);
    } else {
      alert("This job is assigned to Personal Agent (no contractor).");
    }
  }
});

function appendDM(phone, m){
  const arr = msgsFor(phone); arr.push(m); saveMsgsFor(phone, arr);
  const p = loadPartners().find(x=>x.phone===phone);
  if(p && p.telegramId){ sendTelegram(`‚úâÔ∏è Admin: ${m.text}`, p.telegramId); }
}

document.getElementById('sendDM').onclick = ()=>{
  const phone = dmSelect.value;
  const text = document.getElementById('dmText').value.trim();
  if(!phone || !text) return;
  appendDM(phone, {from:'admin', text, when:new Date().toISOString()});
  document.getElementById('dmText').value='';
  document.getElementById('dmOk').style.display='block';
  setTimeout(()=>document.getElementById('dmOk').style.display='none',1500);
};
document.getElementById('broadcastAll').onclick = ()=>{
  const text = prompt("Broadcast to all UNMUTED contractors:");
  if(!text) return;
  loadPartners().filter(p=>!p.muted).forEach(p=>{
    appendDM(p.phone, {from:'admin', text, when:new Date().toISOString()});
  });
  alert("Broadcast sent.");
};

document.getElementById('exportPartners').onclick = ()=>{
  const rows = loadPartners();
  const header = ["business","contact","phone","email","category","service","areas","specialty","website","muted","created"];
  downloadCSV('partners.csv', [header].concat(rows.map(r=>header.map(h=>(r[h]??'').toString().replace(/[\n\r,]/g,' ')))));
};
document.getElementById('exportLeads').onclick = ()=>{
  const rows = jobs();
  const header = ["id","customerName","customerPhone","area","category","service","notes","contractorPhone","created","status"];
  downloadCSV('jobs.csv', [header].concat(rows.map(r=>header.map(h=>(r[h]??'').toString().replace(/[\n\r,]/g,' ')))));
};
document.getElementById('clearPartners').onclick = ()=>{ if(confirm('Delete ALL partners?')){ savePartners([]); renderPartners(); populateDMSelect(); } };
document.getElementById('clearLeads').onclick = ()=>{ if(confirm('Delete ALL jobs/leads?')){ saveJobs([]); saveLeads([]); renderLeads(); } };

function downloadCSV(filename, rows){
  const csv = rows.map(r => r.map(v => `"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}

/* expand all by default on load */
document.querySelectorAll('.group-grid').forEach(g=>g.classList.remove('hidden'));

/* ================== Reviews (client-facing) ================== */
const rBackdrop = document.getElementById('rBackdrop');
document.getElementById('openReview').onclick = ()=> rBackdrop.style.display='grid';
document.getElementById('rClose').onclick = ()=> rBackdrop.style.display='none';
document.getElementById('revSubmit').onclick = ()=>{
  const id = (document.getElementById('revJobId').value||'').trim();
  const stars = parseInt((document.getElementById('revStars').value||'').trim(),10);
  const name = (document.getElementById('revName').value||'').trim();
  const phone = (document.getElementById('revPhone').value||'').trim();
  const comment = (document.getElementById('revComment').value||'').trim();
  if(!id || !stars || stars<1 || stars>5){ alert("Enter Job ID and stars 1‚Äì5."); return; }
  const jlist = jobs();
  const j = jlist.find(x=>x.id===id);
  if(!j){ alert("Job not found."); return; }
  const list = reviews();
  list.push({ jobId:id, contractorPhone: j.contractorPhone || 'agent', stars, comment, customerName:name, customerPhone:phone, when:new Date().toISOString() });
  saveReviews(list);
  document.getElementById('revOk').style.display='block';
  setTimeout(()=>{ rBackdrop.style.display='none'; document.getElementById('revOk').style.display='none'; }, 1600);
};
</script>
</body>
</html>
